"use strict";this.galaxies=this.galaxies||{},galaxies.audio=galaxies.audio||{},galaxies.audio.surroundMix=!1,galaxies.audio.globalGain=1,galaxies.audio.DISTANCE_ATTENUATION=.1,galaxies.audio.DISTANCE_REF=2,galaxies.audio.DISTANCE_ROLL=1,galaxies.audio.DIRECTION_FOCUS=1,galaxies.audio.DOPPLER_FACTOR=70,galaxies.audio.muteState="none",galaxies.audio.positionedSounds=[],galaxies.audio.getSound=function(a){var b=galaxies.audio.loadedSounds[a].next();return"undefined"==typeof b?(console.log("Requested sound not loaded.",a),null):b},galaxies.audio.sounds={shoot:["shoot1","shoot2","shoot3","shoot4","shoot5"],asteroidsplode:["asteroidsplode1","asteroidsplode2","asteroidsplode3"],cometexplode:["cometexplode"],cometloop:["cometloop"],fpo:["fpo1"],ufo:["ufo"],music:["music"],ufohit:["ufohit1","ufohit2"],ufoshoot:["ufoshoot"],planetsplode:["planetsplode"],teleportin:["teleportin"],teleportout:["teleportout"],metalhit:["metalhit1","metalhit2","metalhit3"],titlewoosh:["titlewoosh"],satellitesplode:["satellitesplode"],asteroidhit:["asteroidhit1","asteroidhit2","asteroidhit3","asteroidhit4"],trunkfordlaugh:["trunkfordlaugh1","trunkfordlaugh2","trunkfordlaugh3","trunkfordlaugh4"],buttonover:["buttonover"]},galaxies.audio.initAudio=function(a){function b(a,b){var d=a,e=galaxies.queue.getResult(b,!0);null!=e?galaxies.audio.audioCtx.decodeAudioData(e,function(a){galaxies.audio.loadedSounds[d].add(a),c()},function(){console.log("Error decoding audio file.",d),galaxies.audio.loadedSounds[d].add(galaxies.audio.audioCtx.createBuffer(2,22050,44100)),c()}):(galaxies.audio.loadedSounds[d].add(galaxies.audio.audioCtx.createBuffer(2,22050,44100)),c())}function c(){h--,0>=h&&d()}function d(){for(var a=Object.keys(galaxies.audio.loadedSounds),b=0;b<a.length;b++)galaxies.audio.loadedSounds[a[b]].init();var c=6===galaxies.audio.audioCtx.destination.maxChannelCount||galaxies.utils.isMobile();galaxies.audio.toggleTargetMix(c),f()}var e=window.AudioContext||window.webkitAudioContext;galaxies.audio.audioCtx=galaxies.audio.audioCtx||new e,galaxies.audio.listener=galaxies.audio.audioCtx.listener,console.log("initAudio"),galaxies.audio.outNode=galaxies.audio.audioCtx.createGain(),galaxies.audio.outNode.connect(galaxies.audio.audioCtx.destination),galaxies.utils.supportsEC3&&galaxies.utils.isOSX()&&/Version\/9.0 Safari/.test(navigator.userAgent)&&(galaxies.audio.globalGain=5),galaxies.audio.outNode.gain.value=galaxies.audio.globalGain;for(var f=a,g=Object.keys(galaxies.audio.sounds),h=0,i=0;i<g.length;i++)h+=galaxies.audio.sounds[g[i]].length;galaxies.audio.loadedSounds={};for(var i=0;i<g.length;i++){galaxies.audio.loadedSounds[g[i]]=new galaxies.ExhaustiveArray;for(var j=0;j<galaxies.audio.sounds[g[i]].length;j++)b(g[i],galaxies.audio.sounds[g[i]][j])}},galaxies.audio.channelAngles=[Math.PI/4,-Math.PI/4,0,null,3*Math.PI/4,-3*Math.PI/4],galaxies.audio.PositionedSound=function(a){"boolean"!=typeof a.dispose&&(a.dispose=!0);var b=a.dispose;"boolean"!=typeof a.loop&&(a.loop=!0),this.loop=a.loop,"boolean"!=typeof a.start&&(a.start=!0);var c=a.source;this.toSource=new THREE.Vector3,this.muteVolume=galaxies.audio.audioCtx.createGain(),this.preAmp=galaxies.audio.audioCtx.createGain(),this.muteVolume.connect(this.preAmp),Object.defineProperty(this,"volume",{set:function(a){this._volume=a,this.preAmp.gain.value=this._volume}}),"number"!=typeof a.baseVolume&&(a.baseVolume=1),this.volume=a.baseVolume,this.bearing=0,this.distance=0,this.inPlaneWeight=0;this.channels=[];this.init=function(){for(var a=0;a<this.channels.length;a++)this.preAmp.disconnect(this.channels[a]),this.channels[a].disconnect(this.combiner);if(this.channels=[],null!=this.combiner&&(this.combiner.disconnect(galaxies.audio.outNode),this.combiner=null),null!=this.panner&&(this.preAmp.disconnect(this.panner),this.panner.disconnect(galaxies.audio.outNode),this.panner=null),galaxies.audio.surroundMix){this.combiner=galaxies.audio.audioCtx.createChannelMerger();for(var a=0;6>a;a++){var b=galaxies.audio.audioCtx.createGain();b.gain.value=0,this.preAmp.connect(b),b.connect(this.combiner,0,a),this.channels[a]=b}this.combiner.connect(galaxies.audio.outNode)}else this.panner=galaxies.audio.audioCtx.createPanner(),this.panner.panningModel="HRTF",this.panner.distanceModel="inverse",this.panner.refDistance=2,this.panner.maxDistance=1e4,this.panner.rolloffFactor=1,this.panner.coneInnerAngle=360,this.panner.coneOuterAngle=0,this.panner.coneOuterGain=0,this.preAmp.connect(this.panner),this.panner.connect(galaxies.audio.outNode)},this.updatePosition=function(a){if(this.toSource.subVectors(a,galaxies.audio.listenerObject.position),this.distance=this.toSource.length(),galaxies.audio.surroundMix){this.bearing=Math.atan2(-this.toSource.x,-this.toSource.z),this.inPlaneWeight=0,this.distance>0&&(this.inPlaneWeight=Math.sqrt(Math.pow(this.toSource.x,2)+Math.pow(this.toSource.z,2))/this.distance);for(var b=0;6>b;b++){var c=galaxies.audio.DISTANCE_REF/(galaxies.audio.DISTANCE_REF+galaxies.audio.DISTANCE_ROLL*(this.distance-galaxies.audio.DISTANCE_REF));if(null!==galaxies.audio.channelAngles[b]){var d=(galaxies.audio.channelAngles[b]-this.bearing+galaxies.utils.PI_2+Math.PI)%galaxies.utils.PI_2-Math.PI,e=Math.exp(-d*d*galaxies.audio.DIRECTION_FOCUS);c=c/2*(1-this.inPlaneWeight)+c*e*this.inPlaneWeight}this.channels[b].gain.value=c}}else this.panner.setPosition(a.x,a.y,a.z)},this.startSound=function(){null!=this.source&&this.source.stop(0);try{if(this.source=galaxies.audio.audioCtx.createBufferSource(),this.source.loop=this.loop,this.source.buffer=c,this.source.connect(this.muteVolume),this.source.start(0),b){var a=this;this.source.onended=function(){galaxies.audio.unregisterPositionedSound(a)}}}catch(d){console.log("Unable to start sound",d)}},this.init(),this.updatePosition(a.position),galaxies.audio.registerPositionedSound(this),a.start&&this.startSound()},galaxies.audio.ObjectSound=function(a,b,c,d,e){this.object=b,this.sound=new galaxies.audio.PositionedSound({source:a,position:galaxies.utils.rootPosition(b),baseVolume:c,loop:d,start:e,dispose:!1}),this.lastDistance=0,this.velocity=0,Object.defineProperty(this,"volume",{set:function(a){this._volume=a,this.sound.preAmp.gain.value=this._volume}}),this.update=function(a){if(null!=this.sound.source){this.sound.updatePosition(galaxies.utils.rootPosition(this.object));var b=(this.lastDistance-this.sound.distance)/a;this.sound.source.playbackRate.value=1+b/galaxies.audio.DOPPLER_FACTOR,this.lastDistance=this.sound.distance}}},galaxies.audio.playSound=function(a){var b=galaxies.audio.audioCtx.createBufferSource();b.loop=!1,b.buffer=a,b.connect(galaxies.audio.outNode),b.start(0)},galaxies.audio.SoundField=function(a){var b=[0,1,4,5],c=[2,3];this.source=galaxies.audio.audioCtx.createBufferSource(),this.source.loop=!0,this.source.buffer=a,this.angle=0,this.angularVelocity=1;var d=galaxies.audio.audioCtx.createGain();this.source.connect(d);var e=galaxies.audio.audioCtx.createChannelSplitter(6);d.connect(e);var f=galaxies.audio.audioCtx.createChannelMerger(6);f.connect(galaxies.audio.outNode),this.gains=[];for(var g=0;g<c.length;g++)e.connect(f,c[g],c[g]);for(var h=0;h<b.length;h++){this.gains[h]=[];for(var i=0;i<b.length;i++){var j=galaxies.audio.audioCtx.createGain();e.connect(j,b[i],0),j.connect(f,0,b[h]),this.gains[h][i]=j}}this.setVolume=function(a){d.gain.value=a},this.setVolume(.24),this.source.start(0),this.update=function(a){this.angle+=this.angularVelocity*a;for(var c=0;c<b.length;c++)for(var d=0;d<b.length;d++){var e;null!==galaxies.audio.channelAngles[b[d]]&&(e=(Math.cos(galaxies.audio.channelAngles[b[c]]-(galaxies.audio.channelAngles[b[d]]+this.angle))+1)/2),this.gains[c][d].gain.value=e}}},galaxies.audio.registerPositionedSound=function(a){galaxies.audio.positionedSounds.push(a)},galaxies.audio.unregisterPositionedSound=function(a){var b=galaxies.audio.positionedSounds.indexOf(a);b>=0&&galaxies.audio.positionedSounds.splice(b,1)},galaxies.audio.toggleTargetMix=function(a){galaxies.audio.surroundMix=a,galaxies.ui.setMixButtons(galaxies.audio.surroundMix);for(var b=0,c=galaxies.audio.positionedSounds.length;c>b;b++)galaxies.audio.positionedSounds[b].init();galaxies.audio.surroundMix?galaxies.audio.audioCtx.destination.maxChannelCount>=6&&(galaxies.audio.audioCtx.destination.channelCount=6):galaxies.audio.audioCtx.destination.maxChannelCount>=2&&(galaxies.audio.audioCtx.destination.channelCount=2)},galaxies.audio.toggleMuteState=function(){switch(galaxies.audio.muteState){case"none":galaxies.audio.muteState="music",galaxies.audio.setAllMute(!1),galaxies.audio.setMusicMute(!0);break;case"music":galaxies.audio.muteState="all",galaxies.audio.setAllMute(!0);break;case"none":default:galaxies.audio.muteState="none",galaxies.audio.setAllMute(!1)}},galaxies.audio.setAllMute=function(a){galaxies.audio.setMusicMute(!1),a?galaxies.audio.outNode.gain.value=0:galaxies.audio.outNode.gain.value=galaxies.audio.globalGain},galaxies.audio.setMusicMute=function(a){a?galaxies.audio.soundField.setVolume(0):galaxies.audio.soundField.setVolume(.24)},this.galaxies=this.galaxies||{},galaxies.engine=galaxies.engine||{},galaxies.engine.invulnerable=!1,galaxies.engine.gameInitialized=!1,galaxies.engine.windowHalfX=0,galaxies.engine.windowHalfY=0,galaxies.engine.driftObject,galaxies.engine.rootObject,galaxies.engine.driftSpeed=.05,galaxies.engine.geometries={},galaxies.engine.materials={},galaxies.engine.isPaused=!1,galaxies.engine.isGameOver=!1,galaxies.engine.START_LEVEL_NUMBER=1,galaxies.engine._levelNumber=1,Object.defineProperty(galaxies.engine,"levelNumber",{get:function(){return galaxies.engine._levelNumber},set:function(a){galaxies.engine._levelNumber=a,galaxies.engine.roundNumber=(galaxies.engine.levelNumber-1)%galaxies.engine.ROUNDS_PER_PLANET+1,galaxies.engine.planetNumber=Math.floor((galaxies.engine.levelNumber-1)/galaxies.engine.ROUNDS_PER_PLANET)+1}}),galaxies.engine.levelTimer=0,galaxies.engine.LEVEL_TIME=15,galaxies.engine.levelComplete=!1,galaxies.engine.spawnTimers={},galaxies.engine.spawnTimes={},galaxies.engine.obstacleTypes=["asteroid","satellite","comet"],galaxies.engine.speedScale=1,galaxies.engine.CONE_ANGLE=11.4*Math.PI/360,galaxies.engine.CAMERA_Z=40,galaxies.engine.CAMERA_VIEW_ANGLE=45,galaxies.engine.ROUNDS_PER_PLANET=3,galaxies.engine.SHOOT_TIME=.4,galaxies.engine.PROJ_HIT_THRESHOLD=.7,galaxies.engine.RICOCHET_HIT_THRESHOLD=1.1,galaxies.engine.PLANET_RADIUS=1,galaxies.engine.CHARACTER_HEIGHT=3,galaxies.engine.CHARACTER_POSITION=galaxies.engine.PLANET_RADIUS+.95*galaxies.engine.CHARACTER_HEIGHT/2,galaxies.engine.PROJ_START_Y=galaxies.engine.PLANET_RADIUS+.08*galaxies.engine.CHARACTER_HEIGHT,galaxies.engine.CONE_SLOPE=Math.tan(galaxies.engine.CONE_ANGLE),galaxies.engine.CAMERA_SLOPE=Math.tan(galaxies.engine.CAMERA_VIEW_ANGLE*Math.PI/360),galaxies.engine.VISIBLE_RADIUS=galaxies.engine.CAMERA_Z*galaxies.engine.CONE_SLOPE*galaxies.engine.CAMERA_SLOPE/(galaxies.engine.CONE_SLOPE+galaxies.engine.CAMERA_SLOPE),galaxies.engine.targetAngle=0,galaxies.engine.angle=0,galaxies.engine.obstacles=[],galaxies.engine.inactiveObstacles=[],galaxies.engine.obstaclePool={},galaxies.engine.obstaclePool.asteroid=[],galaxies.engine.obstaclePool.satellite=[],galaxies.engine.obstaclePool.comet=[],galaxies.engine.shotTimer=galaxies.engine.SHOOT_TIME,galaxies.engine.projectiles=[],galaxies.engine.onWindowResize=function(){galaxies.engine.windowHalfX=window.innerWidth/2,galaxies.engine.windowHalfY=window.innerHeight/2,galaxies.engine.camera.aspect=window.innerWidth/window.innerHeight,galaxies.engine.camera.updateProjectionMatrix(),galaxies.engine.renderer.setSize(window.innerWidth,window.innerHeight);var a=(galaxies.engine.camera.aspect+1)/2,b=a*Math.tan(galaxies.engine.CAMERA_VIEW_ANGLE*Math.PI/360);galaxies.engine.OBSTACLE_VISIBLE_RADIUS=galaxies.engine.CAMERA_Z*galaxies.engine.CONE_SLOPE*b/(galaxies.engine.CONE_SLOPE+b),galaxies.engine.OBSTACLE_START_RADIUS=2*galaxies.engine.OBSTACLE_VISIBLE_RADIUS,galaxies.Projectile.prototype.PROJECTILE_LIFE=(galaxies.engine.OBSTACLE_VISIBLE_RADIUS-galaxies.engine.PROJ_START_Y)/galaxies.Projectile.prototype.PROJECTILE_SPEED},galaxies.engine.onVisibilityChange=function(a){console.log("document.hidden:",document.hidden),document.hidden?galaxies.engine.stopTimers():galaxies.engine.isPaused||galaxies.engine.startTimers()},galaxies.engine.init=function(){createjs.Ticker.framerate=60,galaxies.engine.clock=new THREE.Clock,document.addEventListener("visibilitychange",galaxies.engine.onVisibilityChange),galaxies.ui.init()},galaxies.engine.initScene=function(){galaxies.engine.container=document.getElementById("container"),galaxies.engine.scene=new THREE.Scene,galaxies.engine.driftObject=new THREE.Object3D,galaxies.engine.scene.add(galaxies.engine.driftObject),galaxies.engine.rootObject=new THREE.Object3D,galaxies.engine.driftObject.add(galaxies.engine.rootObject),galaxies.engine.camera=new THREE.PerspectiveCamera(galaxies.engine.CAMERA_VIEW_ANGLE,window.innerWidth/window.innerHeight,1,1100),galaxies.engine.camera.position.set(0,0,galaxies.engine.CAMERA_Z),galaxies.engine.rootObject.add(galaxies.engine.camera);var a=new THREE.DirectionalLight(16777215,1);a.position.set(30,20,50),galaxies.engine.rootObject.add(a);var b=new THREE.CubeTexture([galaxies.queue.getResult("skyboxright1"),galaxies.queue.getResult("skyboxleft2"),galaxies.queue.getResult("skyboxtop3"),galaxies.queue.getResult("skyboxbottom4"),galaxies.queue.getResult("skyboxfront5"),galaxies.queue.getResult("skyboxback6")]);b.generateMipMaps=!1,b.magFilter=THREE.LinearFilter,b.minFilter=THREE.LinearFilter,b.needsUpdate=!0;var c=THREE.ShaderLib.cube;c.uniforms.tCube.value=b;var d=new THREE.ShaderMaterial({fragmentShader:c.fragmentShader,vertexShader:c.vertexShader,uniforms:c.uniforms,depthWrite:!1,side:THREE.BackSide});galaxies.engine.skyCube=new THREE.Mesh(new THREE.BoxGeometry(200,200,200),d),galaxies.engine.scene.add(galaxies.engine.skyCube),galaxies.engine.renderer=new THREE.WebGLRenderer,galaxies.engine.renderer.setPixelRatio(window.devicePixelRatio),galaxies.engine.renderer.setSize(window.innerWidth,window.innerHeight),galaxies.engine.container.appendChild(galaxies.engine.renderer.domElement),galaxies.engine.renderer.context.canvas.addEventListener("webglcontextlost",galaxies.engine.handleContextLost,!1),galaxies.engine.renderer.context.canvas.addEventListener("webglcontextrestored",galaxies.engine.handleContextRestored,!1),window.addEventListener("resize",galaxies.engine.onWindowResize,!1),galaxies.engine.onWindowResize(),galaxies.audio.listenerObject=galaxies.engine.camera,galaxies.audio.listener.setOrientation(0,0,-1,0,1,0),galaxies.audio.listener.setPosition(galaxies.audio.listenerObject.position.x,galaxies.audio.listenerObject.position.y,galaxies.audio.listenerObject.position.z);var e=new THREE.Mesh(new THREE.PlaneGeometry(100,100,1),new THREE.MeshBasicMaterial({color:0,transparent:!0,opacity:1,side:THREE.DoubleSide}));e.position.set(0,0,galaxies.engine.CAMERA_Z-5),galaxies.engine.rootObject.add(e),createjs.Tween.get(e.material).to({opacity:0},1e3).call(function(){galaxies.engine.rootObject.remove(e)},this)},galaxies.engine.initGame=function(){var a=new THREE.OBJLoader,b=a.parse(galaxies.queue.getResult("asteroidmodel"));galaxies.engine.geometries.asteroid=b.children[0].geometry;var c=a.parse(galaxies.queue.getResult("projmodel"));galaxies.engine.geometries.proj=c.children[0].geometry;var d=a.parse(galaxies.queue.getResult("satellitemodel"));galaxies.engine.geometries.satellite=d.children[0].geometry;var e=a.parse(galaxies.queue.getResult("moonmodel"));galaxies.engine.geometries.moon=e.children[0].geometry;var f=a.parse(galaxies.queue.getResult("ufomodel"));galaxies.engine.geometries.ufo=f;var g=a.parse(galaxies.queue.getResult("satellitedebrismodel"));galaxies.engine.geometries.debris=g.children[0].geometry;var h=new THREE.Texture(galaxies.queue.getResult("asteroidcolor"),THREE.UVMapping);h.needsUpdate=!0;var i=new THREE.Texture(galaxies.queue.getResult("asteroidnormal"),THREE.UVMapping);i.needsUpdate=!0,galaxies.engine.materials.asteroid=new THREE.MeshPhongMaterial({color:16777215,specular:0,opacity:.4,transparent:!1,map:h,normalMap:i,shading:THREE.SmoothShading});var j=new THREE.Texture(galaxies.queue.getResult("satellitecolor"),THREE.UVMapping);j.needsUpdate=!0,galaxies.engine.materials.satellite=new THREE.MeshPhongMaterial({color:16777215,specular:2105376,shininess:50,opacity:.4,transparent:!1,map:j,shading:THREE.SmoothShading});var k=new THREE.Texture(galaxies.queue.getResult("moonocclusion"),THREE.UVMapping);k.needsUpdate=!0;var l=new THREE.Texture(galaxies.queue.getResult("moonnormal"),THREE.UVMapping);l.needsUpdate=!0,galaxies.engine.materials.moon=new THREE.MeshPhongMaterial({color:11184810,specular:0,map:k,normalMap:l,shading:THREE.SmoothShading});var m=new THREE.Texture(galaxies.queue.getResult("ufocolor"));m.needsUpdate=!0,galaxies.engine.materials.ufo=new THREE.MeshPhongMaterial({color:16777215,specular:6689555,shininess:90,transparent:!1,map:m,shading:THREE.SmoothShading,depthTest:!0}),galaxies.engine.materials.ufocanopy=new THREE.MeshPhongMaterial({color:2236962,specular:526344,shininess:100,opacity:.9,transparent:!0,shading:THREE.SmoothShading,blending:THREE.AdditiveBlending});var n=new THREE.Texture(galaxies.queue.getResult("projcolor"),THREE.UVMapping);n.needsUpdate=!0,galaxies.engine.materials.proj=new THREE.MeshBasicMaterial({color:13421772,map:n,shading:THREE.SmoothShading}),galaxies.engine.materials.debris=new THREE.MeshPhongMaterial({color:10066329,specular:2105376,shininess:50,opacity:1,transparent:!0,shading:THREE.SmoothShading}),galaxies.engine.planet=new THREE.Mesh(galaxies.engine.geometries.moon,galaxies.engine.materials.moon),galaxies.engine.rootObject.add(galaxies.engine.planet),galaxies.engine.characterRotator=new THREE.Object3D,galaxies.engine.rootObject.add(galaxies.engine.characterRotator);var o=new THREE.Texture(galaxies.queue.getResult("lux"));galaxies.engine.characterAnimator=new galaxies.SpriteSheet(o,[[2,2,172,224,0,4,81.35],[176,2,172,224,0,4,81.35],[350,2,172,224,0,4,81.35],[524,2,172,224,0,4,81.35],[698,2,172,224,0,4,81.35],[2,228,172,224,0,4,81.35],[176,228,172,224,0,4,81.35],[350,228,172,224,0,4,81.35],[524,228,172,224,0,4,81.35],[698,228,172,224,0,4,81.35],[2,454,172,224,0,4,81.35],[176,454,172,224,0,4,81.35],[350,454,172,224,0,4,81.35],[524,454,172,224,0,4,81.35],[698,454,172,224,0,4,81.35],[2,680,172,224,0,4,81.35]],30),o.needsUpdate=!0;var p=new THREE.SpriteMaterial({map:o,color:16777215,transparent:!0,opacity:1});galaxies.engine.character=new THREE.Sprite(p),galaxies.engine.character.position.set(.77*galaxies.engine.CHARACTER_HEIGHT*.15,galaxies.engine.CHARACTER_POSITION,0),galaxies.engine.character.scale.set(.77*galaxies.engine.CHARACTER_HEIGHT,galaxies.engine.CHARACTER_HEIGHT,.77*galaxies.engine.CHARACTER_HEIGHT),galaxies.engine.characterRotator.add(galaxies.engine.character),galaxies.engine.addInputListeners(),galaxies.fx.init(galaxies.engine.scene),galaxies.engine.startGame()},galaxies.engine.startGame=function(){galaxies.engine.ufo=new galaxies.Ufo,galaxies.engine.resetGame(),galaxies.engine.removeInputListeners(),galaxies.engine.planetTransition(),galaxies.engine.gameInitialized=!0,null==galaxies.engine.animationFrameRequest&&galaxies.engine.animate()},galaxies.engine.restartGame=function(){galaxies.ui.showPauseButton(),galaxies.engine.rootObject.add(galaxies.engine.characterRotator),galaxies.engine.resetGame(),galaxies.engine.removeInputListeners(),galaxies.engine.planetTransition(),createjs.Ticker.paused=!1,galaxies.engine.clock.start(),null==galaxies.engine.animationFrameRequest&&galaxies.engine.animate()},galaxies.engine.initLevel=function(){galaxies.engine.levelTimer=0,galaxies.engine.levelComplete=!1;var a=1+1/(1+Math.exp(4-galaxies.engine.planetNumber)),b=1+1.5/(1+Math.exp(1-galaxies.engine.planetNumber/2));galaxies.engine.speedScale=THREE.Math.mapLinear(galaxies.engine.roundNumber,1,3,a,b);var c=3-2.3*(1/(1+.1*(galaxies.engine.levelNumber-1))),d=.6-.4*(1/(1+.1*(galaxies.engine.levelNumber-1))),e=.6-.45*(1/(1+.1*(galaxies.engine.levelNumber-1)));galaxies.engine.spawnTimes.asteroid=1/c,galaxies.engine.spawnTimes.satellite=1/d,galaxies.engine.spawnTimes.comet=1/e;for(var f=0,g=galaxies.engine.obstacleTypes.length;g>f;f++)galaxies.engine.spawnTimers[galaxies.engine.obstacleTypes[f]]=(.5+.5*Math.random())*galaxies.engine.spawnTimes[galaxies.engine.obstacleTypes[f]];galaxies.engine.levelNumber>=3&&galaxies.engine.ufo.activate(),galaxies.ui.updateLevel(galaxies.engine.planetNumber,galaxies.engine.roundNumber),galaxies.ui.showTitle("ROUND "+galaxies.engine.roundNumber,3)},galaxies.engine.nextLevel=function(){galaxies.engine.levelNumber++,galaxies.engine.clearLevel(),1==galaxies.engine.roundNumber?(galaxies.engine.initRootRotation(),galaxies.engine.planetTransition()):galaxies.engine.initLevel()},galaxies.engine.planetTransition=function(){galaxies.engine.levelComplete=!1,galaxies.engine.levelTimer=0;for(var a=0,b=galaxies.engine.obstacleTypes.length;b>a;a++)galaxies.engine.spawnTimes[galaxies.engine.obstacleTypes[a]]=1/0;galaxies.engine.removeInputListeners(),galaxies.engine.isFiring=!1,console.log("begin planet transition"),null!=galaxies.engine.planet.parent?(galaxies.fx.showTeleportOut(),new galaxies.audio.PositionedSound({source:galaxies.audio.getSound("teleportout"),position:galaxies.utils.rootPosition(galaxies.engine.character),baseVolume:10,loop:!1}),createjs.Tween.removeTweens(galaxies.engine.character),createjs.Tween.get(galaxies.engine.character).wait(1500).call(galaxies.engine.startPlanetMove,null,this)):galaxies.engine.startPlanetMove()},galaxies.engine.startPlanetMove=function(){console.log("planet move"),null!=galaxies.engine.planet.parent&&THREE.SceneUtils.detach(galaxies.engine.planet,galaxies.engine.rootObject,galaxies.engine.scene);var a=galaxies.engine.rootObject.localToWorld(new THREE.Vector3(0,0,-100)),b=galaxies.engine.rootObject.localToWorld(new THREE.Vector3(0,100,0)),c=6500;createjs.Tween.removeTweens(galaxies.engine.planet.position),createjs.Tween.get(galaxies.engine.planet.position).to({x:a.x,y:a.y,z:a.z},c/2,createjs.Ease.quadInOut).to({x:b.x,y:b.y,z:b.z},0).call(function(){galaxies.engine.scene.add(galaxies.engine.planet),galaxies.engine.randomizePlanet(),galaxies.ui.showTitle(galaxies.utils.generatePlanetName(galaxies.engine.planetNumber),5)},null,this).to({x:0,y:0,z:0},c/2,createjs.Ease.quadInOut);var d=galaxies.engine.rootObject.rotation.x+Math.PI/2;createjs.Tween.removeTweens(galaxies.engine.rootObject.rotation),createjs.Tween.get(galaxies.engine.rootObject.rotation).to({x:d},c,createjs.Ease.quadInOut).call(galaxies.engine.planetMoveComplete),galaxies.engine.driftAxis=galaxies.engine.driftObject.localToWorld(new THREE.Vector3(0,0,1))},galaxies.engine.planetMoveComplete=function(){THREE.SceneUtils.attach(galaxies.engine.planet,galaxies.engine.scene,galaxies.engine.rootObject),galaxies.engine.planetAngle=galaxies.engine.planet.rotation.z,galaxies.engine.characterRotator.add(galaxies.engine.character),galaxies.fx.showTeleportIn(galaxies.engine.planetTransitionComplete),new galaxies.audio.PositionedSound({source:galaxies.audio.getSound("teleportin"),position:galaxies.utils.rootPosition(galaxies.engine.character),baseVolume:10,loop:!1})},galaxies.engine.planetTransitionComplete=function(){galaxies.engine.addInputListeners(),galaxies.engine.initLevel()},galaxies.engine.randomizePlanet=function(){galaxies.engine.planet.rotation.set(Math.random()*galaxies.utils.PI_2,Math.random()*galaxies.utils.PI_2,Math.random()*galaxies.utils.PI_2,"ZXY"),galaxies.engine.planet.material.color.setHSL(Math.random(),THREE.Math.randFloat(.1,.4),THREE.Math.randFloat(.5,.7)),galaxies.engine.planetAngle=galaxies.engine.planet.rotation.z},galaxies.engine.onDocumentMouseDown=function(a){a.preventDefault(),galaxies.engine.isFiring=!0},galaxies.engine.onDocumentTouchStart=function(a){a.preventDefault(),galaxies.engine.isFiring=!0,galaxies.engine.onDocumentTouchMove(a)},galaxies.engine.onDocumentMouseUp=function(a){galaxies.engine.isFiring=!1},galaxies.engine.onDocumentMouseMove=function(a){var b=a.clientX-galaxies.engine.windowHalfX,c=a.clientY-galaxies.engine.windowHalfY;galaxies.engine.targetAngle=-(Math.atan2(c,b)+Math.PI/2)},galaxies.engine.onDocumentTouchMove=function(a){a.preventDefault();for(var b=a.changedTouches,c=0;c<b.length;c++){var d=b[c].clientX-galaxies.engine.windowHalfX,e=b[c].clientY-galaxies.engine.windowHalfY;galaxies.engine.targetAngle=-(Math.atan2(e,d)+Math.PI/2)}},galaxies.engine.addObstacle=function(a){if(galaxies.engine.obstaclePool[a].length>0){var b=galaxies.engine.obstaclePool[a].pop();return b.reset(),void galaxies.engine.obstacles.push(b)}var c={};switch(c.speed=.2,c.tumble=!1,c.tumbleOnHit=!0,c.spiral=0,c.points=100,c.hitSound="asteroidhit",c.explodeSound="asteroidsplode",c.passSound=null,c.orient=!1,c.explodeType="rubble",c.type=a,a){case"asteroid":c.speed=.2,c.tumble=!0,c.points=100,c.hitSound="asteroidhit",c.explodeSound="asteroidsplode";var d=new THREE.MeshPhongMaterial;d.setValues(galaxies.engine.materials.asteroid),c.model=new THREE.Mesh(galaxies.engine.geometries.asteroid,d),c.model.scale.set(.5,.5,.5),c.anchor=c.model;break;case"satellite":c.speed=.5,c.spiral=.7,c.points=250,c.orient=!0,c.explodeType="debris",c.hitSound="metalhit",c.explodeSound="satellitesplode";var d=new THREE.MeshPhongMaterial;d.setValues(galaxies.engine.materials.satellite);var e=new THREE.Mesh(galaxies.engine.geometries.satellite,d);e.position.y=-2,e.rotation.y=Math.random()*galaxies.utils.PI_2;var f=new THREE.Object3D;f.add(e),f.rotation.x=1.3,f.rotation.z=.5,c.anchor=new THREE.Object3D,c.anchor.add(f);var g=.4;c.anchor.scale.set(g,g,g),c.model=f;break;case"comet":c.speed=1.2,c.spiral=1,c.points=500,c.orient=!0,c.tumbleOnHit=!1,c.explodeType="fireworks",c.explodeSound="cometexplode",c.explosionGain=7,c.passSound="cometloop";var h={type:"cube",positionSpread:new THREE.Vector3(.6,.6,.6),velocity:new THREE.Vector3(0,0,-5),velocitySpread:new THREE.Vector3(.2,.2,2),sizeStart:6,sizeStartSpread:4,sizeEnd:2,opacityStart:.8,opacityEnd:.1,colorStart:new THREE.Color("rgb(6, 6, 20)"),colorEnd:new THREE.Color("rgb(255, 77, 0)"),particlesPerSecond:10,particleCount:200,alive:1,duration:null},i=new THREE.Texture(galaxies.queue.getResult("starparticle"));i.needsUpdate=!0;var j=new SPE.Group({texture:i,maxAge:1.5,blending:THREE.AdditiveBlending});j.addEmitter(new SPE.Emitter(h)),c.particleGroup=j,c.anchor=j.mesh;var k=new THREE.SpriteMaterial({map:i,color:16777215,fog:!0,blending:THREE.AdditiveBlending}),l=new THREE.Sprite(k);c.anchor.add(l)}var b=new galaxies.Obstacle(c);galaxies.engine.obstacles.push(b)},galaxies.engine.shoot=function(){if(!(galaxies.engine.shotTimer>0)){galaxies.engine.shotTimer=galaxies.engine.SHOOT_TIME;var a=new THREE.Mesh(galaxies.engine.geometries.proj,galaxies.engine.materials.proj),b=.1;a.scale.set(b,b,b);var c=new galaxies.Projectile(a,galaxies.engine.angle);galaxies.engine.projectiles.push(c),galaxies.engine.characterAnimator.play(),createjs.Tween.get(galaxies.engine.character).wait(250).call(galaxies.engine.shootSync,[c],this)}},galaxies.engine.shootSync=function(a){new galaxies.audio.PositionedSound({source:galaxies.audio.getSound("shoot"),position:galaxies.utils.rootPosition(galaxies.engine.character),baseVolume:10,loop:!1}),a.updatePosition(galaxies.engine.angle),a.addToScene()},galaxies.engine.animate=function(){galaxies.engine.animationFrameRequest=requestAnimationFrame(galaxies.engine.animate),galaxies.engine.update()},galaxies.engine.update=function(){var a=galaxies.engine.clock.getDelta();if(0!==a){a>.25&&(a=.25);for(var b=0,c=0,d=galaxies.engine.obstacles.length;d>c;c++){var e=galaxies.engine.obstacles[c];if("inactive"===e.state?galaxies.engine.inactiveObstacles.push(e):b++,"inactive"!==e.state&&"waiting"!==e.state){for(var f=c+1,g=galaxies.engine.obstacles.length;g>f;f++){var h=galaxies.engine.obstacles[f];if("inactive"!==h.state&&"waiting"!==h.state){var i=e.object.position.distanceTo(h.object.position);if(i<galaxies.engine.RICOCHET_HIT_THRESHOLD)if("ricocheting"!==e.state&&"ricocheting"!==h.state){var j=galaxies.engine.RICOCHET_HIT_THRESHOLD-i,k=h.object.position.clone();k.sub(e.object.position),k.z=0,k.setLength(j/2),e.object.position.sub(k),h.object.position.add(k)}else if(e.isActive&&h.isActive){var l=h.ricochetCount,m=e.ricochetCount,n=h.object.position.clone(),o=e.object.position.clone();h.hit(o,m),e.hit(n,l)}}}for(var p=0,q=galaxies.engine.projectiles.length;q>p;p++){var r=galaxies.engine.projectiles[p];e.isActive&&r.object.position.distanceTo(e.object.position)<galaxies.engine.PROJ_HIT_THRESHOLD&&(e.hit(r.object.position),r.destroy())}}}if(galaxies.engine.ufo.isHittable)for(var p=0,q=galaxies.engine.projectiles.length;q>p;p++){var r=galaxies.engine.projectiles[p],s=galaxies.engine.ufo.object.localToWorld(new THREE.Vector3);s=galaxies.engine.rootObject.worldToLocal(s),r.object.position.distanceTo(s)<galaxies.engine.PROJ_HIT_THRESHOLD&&(galaxies.engine.ufo.hit(),r.destroy())}for(var t=0;t<galaxies.engine.inactiveObstacles.length;t++){var u=galaxies.engine.inactiveObstacles[t];galaxies.engine.obstacles.splice(galaxies.engine.obstacles.indexOf(u),1),galaxies.engine.obstaclePool[u.type].push(u)}galaxies.engine.inactiveObstacles=[];for(var t=0,v=galaxies.engine.obstacles.length;v>t;t++){var w=galaxies.engine.obstacles[t];w.update(a),galaxies.utils.conify(w.object)}for(var x=[],t=0,v=galaxies.engine.projectiles.length;v>t;t++){var r=galaxies.engine.projectiles[t];r.update(a),galaxies.utils.conify(r.object),r.isExpired&&x.push(r)}for(var t=0,v=x.length;v>t;t++){var r=x[t];galaxies.engine.projectiles.splice(galaxies.engine.projectiles.indexOf(r),1),r.remove()}if(galaxies.engine.shotTimer>0&&(galaxies.engine.shotTimer-=a),galaxies.engine.isFiring&&galaxies.engine.shoot(),galaxies.engine.ufo.update(a),galaxies.engine.driftObject.rotateOnAxis(galaxies.engine.driftAxis,galaxies.engine.driftSpeed*a),galaxies.fx.update(a),!galaxies.engine.isGameOver){var y=galaxies.engine.targetAngle-galaxies.engine.angle;y%=2*Math.PI,y>Math.PI&&(y-=2*Math.PI),y<-Math.PI&&(y+=2*Math.PI),galaxies.engine.angle+=y*a*10,galaxies.engine.characterRotator.rotation.set(0,0,galaxies.engine.angle),galaxies.engine.character.material.rotation=galaxies.engine.angle,galaxies.engine.characterAnimator.update(a),galaxies.engine.planet.parent===galaxies.engine.rootObject&&(galaxies.engine.planet.rotation.z=galaxies.engine.planetAngle-galaxies.engine.angle/4)}if(!galaxies.engine.levelComplete)for(var t=0,v=galaxies.engine.obstacleTypes.length;v>t;t++){var z=galaxies.engine.obstacleTypes[t];galaxies.engine.spawnTimers[z]+=a,galaxies.engine.spawnTimers[z]>=galaxies.engine.spawnTimes[z]&&(galaxies.engine.spawnTimers[z]-=galaxies.engine.spawnTimes[z],galaxies.engine.addObstacle(z))}galaxies.engine.levelTimer+=a,galaxies.engine.levelTimer>galaxies.engine.LEVEL_TIME&&(galaxies.engine.levelComplete=!0),!galaxies.engine.levelComplete||0!==b||"idle"!==galaxies.engine.ufo.state&&"inactive"!==galaxies.engine.ufo.state||galaxies.engine.nextLevel(),galaxies.audio.soundField.update(a),galaxies.engine.renderer.render(galaxies.engine.scene,galaxies.engine.camera)}},galaxies.engine.initRootRotation=function(){galaxies.engine.driftAxis=new THREE.Vector3(2*Math.random()-1,2*Math.random()-1,2*Math.random()-1),galaxies.engine.driftAxis.normalize},galaxies.engine.hitPlayer=function(){return galaxies.engine.isGameOver?void 0:(galaxies.engine.playerLife--,galaxies.ui.updateLife(galaxies.engine.playerLife),!galaxies.engine.invulnerable&&galaxies.engine.playerLife<=0?(createjs.Tween.removeTweens(galaxies.engine.character.position),void galaxies.engine.gameOver()):void(createjs.Tween.hasActiveTweens(galaxies.engine.character.position)||createjs.Tween.get(galaxies.engine.character.position).to({y:galaxies.engine.PLANET_RADIUS+galaxies.engine.CHARACTER_HEIGHT},250,createjs.Ease.quadOut).to({y:galaxies.engine.CHARACTER_POSITION},250,createjs.Ease.quadOut)))},
galaxies.engine.stopTimers=function(){createjs.Ticker.paused=!0,galaxies.engine.clock.stop()},galaxies.engine.startTimers=function(){createjs.Ticker.paused=!1,galaxies.engine.clock.start()},galaxies.engine.pauseGame=function(){galaxies.engine.isPaused=!0,galaxies.engine.stopTimers(),null!=galaxies.engine.animationFrameRequest&&(window.cancelAnimationFrame(galaxies.engine.animationFrameRequest),galaxies.engine.animationFrameRequest=null)},galaxies.engine.resumeGame=function(){galaxies.engine.isPaused=!1,galaxies.engine.startTimers(),null==galaxies.engine.animationFrameRequest&&galaxies.engine.animate()},galaxies.engine.gameOver=function(){galaxies.engine.isGameOver=!0,galaxies.fx.showPlanetSplode(),galaxies.fx.shakeCamera(1.5,2),galaxies.engine.removeInputListeners(),galaxies.engine.isFiring=!1;for(var a=0,b=galaxies.engine.obstacles.length;b>a;a++)galaxies.engine.obstacles[a].retreat();galaxies.engine.ufo.leave(),galaxies.ui.hidePauseButton(),createjs.Tween.get(null).wait(2e3).call(galaxies.ui.showGameOver)},galaxies.engine.endGame=function(){null!=galaxies.engine.animationFrameRequest&&(window.cancelAnimationFrame(galaxies.engine.animationFrameRequest),galaxies.engine.animationFrameRequest=null),galaxies.engine.resetGame(),null!=galaxies.engine.planet.parent&&galaxies.engine.planet.parent.remove(galaxies.engine.planet),galaxies.engine.rootObject.remove(galaxies.engine.characterRotator),galaxies.ui.showMenu()},galaxies.engine.resetGame=function(){galaxies.engine.isGameOver=!1,galaxies.engine.clearLevel(),galaxies.engine.levelNumber=galaxies.engine.START_LEVEL_NUMBER,galaxies.engine.score=0,galaxies.engine.playerLife=3,galaxies.engine.addInputListeners(),galaxies.engine.characterRotator.remove(galaxies.engine.character),null!=galaxies.engine.planet.parent&&galaxies.engine.planet.parent.remove(galaxies.engine.planet),galaxies.engine.randomizePlanet(),galaxies.engine.characterAnimator.updateFrame(0),galaxies.engine.character.rotation.set(0,0,0),galaxies.engine.character.material.rotation=galaxies.engine.angle,galaxies.engine.character.position.y=galaxies.engine.CHARACTER_POSITION,galaxies.ui.updateLevel(1,1),galaxies.ui.updateLife(galaxies.engine.playerLife),galaxies.ui.updateScore(galaxies.engine.score),galaxies.ui.clearTitle(),createjs.Tween.removeTweens(galaxies.engine.character),createjs.Tween.removeTweens(galaxies.engine.rootObject.rotation),createjs.Tween.removeTweens(galaxies.engine.planet.position)},galaxies.engine.clearLevel=function(){for(var a=0,b=galaxies.engine.obstacles.length;b>a;a++){var c=galaxies.engine.obstacles[a];c.deactivate(),galaxies.engine.obstaclePool[c.type].push(c)}galaxies.engine.obstacles=[],galaxies.engine.ufo.deactivate()},galaxies.engine.addInputListeners=function(){document.addEventListener("mousedown",galaxies.engine.onDocumentMouseDown,!1),document.addEventListener("mouseup",galaxies.engine.onDocumentMouseUp,!1),document.addEventListener("mousemove",galaxies.engine.onDocumentMouseMove,!1),document.addEventListener("touchstart",galaxies.engine.onDocumentTouchStart,!1),document.addEventListener("touchend",galaxies.engine.onDocumentMouseUp,!1),document.addEventListener("touchleave",galaxies.engine.onDocumentMouseUp,!1),document.addEventListener("touchmove",galaxies.engine.onDocumentTouchMove,!1)},galaxies.engine.removeInputListeners=function(){document.removeEventListener("mousedown",galaxies.engine.onDocumentMouseDown,!1),document.removeEventListener("mouseup",galaxies.engine.onDocumentMouseUp,!1),document.removeEventListener("mousemove",galaxies.engine.onDocumentMouseMove,!1),document.removeEventListener("touchstart",galaxies.engine.onDocumentTouchStart,!1),document.removeEventListener("touchend",galaxies.engine.onDocumentMouseUp,!1),document.removeEventListener("touchleave",galaxies.engine.onDocumentMouseUp,!1),document.removeEventListener("touchmove",galaxies.engine.onDocumentTouchMove,!1)},galaxies.engine.handleContextLost=function(a){console.log("WebGL Context Lost",a)},galaxies.engine.handleContextRestored=function(){console.log("WebGL Context Restored",e)},galaxies.engine.showCombo=function(a,b){var c=new THREE.Vector3;c.setFromMatrixPosition(b.matrixWorld),c.project(galaxies.engine.camera);var d=c.x*galaxies.engine.windowHalfX+galaxies.engine.windowHalfX,e=-(c.y*galaxies.engine.windowHalfY)+galaxies.engine.windowHalfY,f=50;d=Math.max(d,f),d=Math.min(d,window.innerWidth-f),e=Math.max(e,f),e=Math.min(e,window.innerHeight-f);var g=document.createElement("div");g.classList.add("points");var h=document.createTextNode(a.toString());g.style.left=d+"px",g.style.top=e+"px",g.appendChild(h),galaxies.engine.container.appendChild(g),window.getComputedStyle(g).top,g.style.top=e-40+"px",g.style.opacity=0,window.setTimeout(galaxies.engine.removeCombo,2e3,g),galaxies.engine.score+=a,galaxies.ui.updateScore(galaxies.engine.score)},galaxies.engine.removeCombo=function(a){a.remove()},galaxies.start=function(){if(!galaxies.utils.isSupportedBrowser()){var a=window.location.href;return a=a.substring(0,a.lastIndexOf("/")),a+="/unsupported.html",void window.location.assign(a)}if(galaxies.utils.isMobile()){var b=document.body.querySelector(".touch-to-start");b.classList.remove("hidden"),b.addEventListener("click",function(){b.remove();var a=window.AudioContext||window.webkitAudioContext;galaxies.audio.audioCtx=new a;var c=galaxies.audio.audioCtx.createOscillator();c.frequency.value=4e3,c.connect(galaxies.audio.audioCtx.destination),c.start(0),c.stop(0),galaxies.engine.init()})}else{var b=document.body.querySelector(".touch-to-start");b.remove(),galaxies.engine.init()}},this.galaxies=this.galaxies||{},galaxies.fx=function(){var a=5,b=3,c=new THREE.MeshLambertMaterial({color:8680288,opacity:1,transparent:!0}),d=function(a,b,c){this.object=new THREE.Mesh(a,b.clone()),c*=Math.random()+.5,this.object.scale.set(c,c,c),this.object.rotation.set(THREE.Math.randFloatSpread(galaxies.utils.PI_2),THREE.Math.randFloatSpread(galaxies.utils.PI_2),THREE.Math.randFloatSpread(galaxies.utils.PI_2)),this.velocity=new THREE.Vector3(0,0,0),this.rotationAxis=new THREE.Vector3(Math.random()-.5,Math.random()-.5,Math.random()-.5),this.rotationAxis.normalize(),this.rotationSpeed=10*(Math.random()-.5),this.active=!1,this.lifetime=2,this.lifeTimer=0};d.prototype.update=function(a){this.active&&(this.object.rotateOnAxis(this.rotationAxis,this.rotationSpeed*a),this.object.position.set(this.object.position.x+this.velocity.x*a,this.object.position.y+this.velocity.y*a,this.object.position.z+this.velocity.z*a),this.object.material.opacity=(this.lifetime-this.lifeTimer)/this.lifetime,this.lifeTimer+=a,this.lifeTimer>=this.lifetime&&(this.active=!1,galaxies.engine.rootObject.remove(this.object)))},d.prototype.reset=function(){this.lifeTimer=0,this.active=!0,this.lifetime=2,galaxies.engine.rootObject.add(this.object)};var e,f,g,h,i={type:"cube",positionSpread:new THREE.Vector3(.1,.1,.1),velocity:new THREE.Vector3(0,0,7),velocitySpread:new THREE.Vector3(3,3,10),sizeStart:.2,sizeStartSpread:.1,sizeEnd:.15,opacityStart:1,opacityEnd:0,colorStart:new THREE.Color("hsl(0, 0%, 70%)"),colorEnd:new THREE.Color("hsl(0, 0%, 70%)"),particleCount:40,alive:0,duration:.05},j=[],k=0,l=3,m=[],n=0,o=8,p=24,q=[],r=0,s=8,t=16,u=[],v=15,w=1500,x=w/2,y=!1,z=function(){var a=new THREE.Texture(galaxies.queue.getResult("projhitparticle"));a.needsUpdate=!0;for(var b=0;l>b;b++){var k=new SPE.Group({texture:a,maxAge:.5,blending:THREE.NormalBlending});j[b]=k,galaxies.engine.rootObject.add(k.mesh),k.addPool(1,i,!1)}for(var b=0;p>b;b++){var n=new d(galaxies.engine.geometries.asteroid,c,.1);m[b]=n}for(var b=0;t>b;b++){var o=new d(galaxies.engine.geometries.debris,galaxies.engine.materials.debris,.2);q[b]=o}var r={type:"sphere",radius:.6,acceleration:new THREE.Vector3(0,0,-v),speed:5,speedSpread:3,sizeStart:2,sizeStartSpread:1,sizeEnd:1,opacityStart:1,opacityEnd:.5,colorStart:new THREE.Color("rgb(255, 150, 100)"),colorStartSpread:new THREE.Vector3(.5,.7,1),colorEnd:new THREE.Color("rgb(0, 0, 0)"),particlesPerSecond:1e3,particleCount:200,alive:1,duration:.1},s=new THREE.Texture(galaxies.queue.getResult("starparticle"));s.needsUpdate=!0,f=new SPE.Group({texture:s,maxAge:1.5,blending:THREE.AdditiveBlending}),f.addPool(3,r,!0),galaxies.engine.rootObject.add(f.mesh),e=new THREE.Object3D,e.scale.set(3,3,3),galaxies.engine.rootObject.add(e);var w={type:"sphere",radius:.1,speed:12,speedSpread:10,sizeStart:.6,sizeStartSpread:.2,sizeEnd:.6,opacityStart:.5,opacityStartSpread:.8,opacityEnd:0,colorStart:new THREE.Color(.5,.5,.5),colorStartSpread:new THREE.Vector3(.4,.4,.4),particlesPerSecond:1e4,particleCount:1e3,alive:0,duration:.1},x=new SPE.Group({texture:a,maxAge:2,blending:THREE.NormalBlending});x.addEmitter(new SPE.Emitter(w)),x.mesh.position.set(0,0,1),u.push(x);var y={type:"sphere",radius:.1,acceleration:new THREE.Vector3(0,0,-40),speed:10,speedSpread:6,sizeStart:8,sizeStartSpread:6,sizeEnd:6,opacityStart:.5,opacityStartSpread:.8,opacityEnd:0,colorStart:new THREE.Color(.8,.4,.1),colorStartSpread:new THREE.Vector3(.1,.2,.4),colorEnd:new THREE.Color(.5,0,0),particlesPerSecond:2e3,particleCount:200,alive:0,duration:.1},z=new SPE.Group({texture:a,maxAge:1.5,blending:THREE.AdditiveBlending});z.addEmitter(new SPE.Emitter(y)),z.mesh.position.set(0,0,.1),u.push(z);var A=new THREE.Texture(galaxies.queue.getResult("lux"));h=new galaxies.SpriteSheet(A,[[176,680,172,224,0,4,81.35],[350,680,172,224,0,4,81.35],[524,680,172,224,0,4,81.35],[698,680,172,224,0,4,81.35]],30),A.needsUpdate=!0;var B=new THREE.SpriteMaterial({map:A,color:16777215,transparent:!0,opacity:0});g=new THREE.Sprite(B),g.position.z=.1},A=function(a){var b=f.getFromPool();if(null===b)return void console.log("SPE.Group pool ran out.");a instanceof THREE.Vector3&&b._position.copy(a);var c=new THREE.Vector3;c.subVectors(a,galaxies.engine.camera.position),c.normalize(),c.multiplyScalar(v),b.acceleration=c,b.enable(),setTimeout(function(){b.disable(),f.releaseIntoPool(b)},f.maxAgeMilliseconds)},B=function(a){var b=j[k];k++,k>=l&&(k=0),b.mesh.position.copy(a),b.mesh.lookAt(galaxies.engine.rootObject.position),b.triggerPoolEmitter(1)},C=function(a,b){n=E(m,o,n,a,b)},D=function(a,b){r=E(q,s,r,a,b)},E=function(a,b,c,d,e){for(var f=a.length,g=0;b>g;g++){var h=a[c];h.object.position.copy(d),h.object.position.add(new THREE.Vector3(THREE.Math.randFloatSpread(.5),THREE.Math.randFloatSpread(.5),THREE.Math.randFloatSpread(.5))),galaxies.engine.rootObject.add(h.object),h.velocity.subVectors(h.object.position,d),h.velocity.normalize(),h.velocity.add(e),h.reset(),c++,c>=f&&(c=0)}return c},F=function(){galaxies.engine.rootObject.remove(galaxies.engine.planet);for(var a=0;p>a;a++){var b=m[a];b.object.position.set(THREE.Math.randFloatSpread(.5),THREE.Math.randFloatSpread(.5),THREE.Math.randFloatSpread(.5)),b.velocity.copy(b.object.position),b.velocity.normalize(),b.velocity.multiplyScalar(2),b.reset(),b.lifetime=6,e.add(b.object)}for(var a=0;a<u.length;a++){var c=u[a];galaxies.engine.rootObject.add(c.mesh);var d=u[a].emitters[0];d.alive=1,d.enable(),function(){var a=d,b=c;setTimeout(function(){a.disable(),galaxies.engine.rootObject.remove(b.mesh)},b.maxAgeMilliseconds)}()}galaxies.engine.characterAnimator.updateFrame(10),new galaxies.audio.PositionedSound({source:galaxies.audio.getSound("planetsplode"),position:galaxies.engine.rootObject.position,baseVolume:16,loop:!1})},G=function(){galaxies.engine.character.add(g),g.material.rotation=galaxies.engine.character.material.rotation,g.material.opacity=0,h.play(-1),createjs.Tween.removeTweens(g.material),createjs.Tween.get(g.material).to({opacity:1},x).set({opacity:0},galaxies.engine.character.material).to({opacity:0},x).call(H,this),y=!0},H=function(){h.stop(),g.parent.remove(g),y=!1},I=function(a){galaxies.engine.angle=0,galaxies.engine.targetAngle=0,galaxies.engine.character.add(g),g.material.rotation=galaxies.engine.character.material.rotation,g.material.opacity=0,h.play(-1),galaxies.engine.character.material.opacity=0,createjs.Tween.removeTweens(g.material),createjs.Tween.get(g.material).to({opacity:1},x).set({opacity:1},galaxies.engine.character.material).to({opacity:0},x).call(H,this).call(a,this),y=!0},J=function(c){for(var d=0;l>d;d++)j[d].tick(c);for(var d=0;p>d;d++)m[d].update(c);for(var d=0;t>d;d++)q[d].update(c);f.tick(c);for(var d=0;d<u.length;d++)u[d].tick(c);galaxies.engine.isGameOver&&(galaxies.engine.character.position.y=galaxies.engine.character.position.y+a*c,galaxies.engine.character.rotation.z=galaxies.engine.character.rotation.z+b*c,galaxies.engine.character.material.rotation=galaxies.engine.character.rotation.z),y&&(h.update(c),g.material.rotation=galaxies.engine.character.material.rotation)},K=function(a,b){galaxies.engine.camera.rotation.x=0,galaxies.engine.camera.rotation.y=0,b="undefined"==typeof b?500:1e3*b,a=.01*a;var c=b/17,d=b/18;createjs.Tween.get(galaxies.engine.camera.rotation).to({x:a,override:!0},b,galaxies.utils.getShakeEase(c)).to({x:0},0),createjs.Tween.get(galaxies.engine.camera.rotation).to({y:a,override:!0},b,galaxies.utils.getShakeEase(d)).to({y:0},0)};return{init:z,update:J,showHit:B,showFireworks:A,showRubble:C,showPlanetSplode:F,showTeleportOut:G,showTeleportIn:I,shakeCamera:K,showDebris:D}}(),this.galaxies=this.galaxies||{},this.galaxies.loadAssets=function(a,b,c){var d,e=[];d=galaxies.utils.supportsEC3?".mp4":galaxies.utils.supportsOGG?".ogg":".m4a",console.log("Audio extension selected:",d);for(var f=[{id:"shoot1",src:"shuttlecock_release_01",type:createjs.AbstractLoader.BINARY},{id:"shoot2",src:"shuttlecock_release_02",type:createjs.AbstractLoader.BINARY},{id:"shoot3",src:"shuttlecock_release_03",type:createjs.AbstractLoader.BINARY},{id:"shoot4",src:"shuttlecock_release_04",type:createjs.AbstractLoader.BINARY},{id:"shoot5",src:"shuttlecock_release_05",type:createjs.AbstractLoader.BINARY},{id:"asteroidsplode1",src:"asteroid_explode_01",type:createjs.AbstractLoader.BINARY},{id:"asteroidsplode2",src:"asteroid_explode_02",type:createjs.AbstractLoader.BINARY},{id:"asteroidsplode3",src:"asteroid_explode_03",type:createjs.AbstractLoader.BINARY},{id:"cometexplode",src:"comet_explode_01",type:createjs.AbstractLoader.BINARY},{id:"cometloop",src:"comet_fire_loop",type:createjs.AbstractLoader.BINARY},{id:"fpo1",src:"UFO_laser_fire",type:createjs.AbstractLoader.BINARY},{id:"ufo",src:"ufo_engine_loop",type:createjs.AbstractLoader.BINARY},{id:"music",src:"music_5_1_loop",type:createjs.AbstractLoader.BINARY},{id:"ufohit1",src:"ufo_hit_01",type:createjs.AbstractLoader.BINARY},{id:"ufohit2",src:"ufo_hit_02",type:createjs.AbstractLoader.BINARY},{id:"ufoshoot",src:"UFO_laser_fire",type:createjs.AbstractLoader.BINARY},{id:"planetsplode",src:"planet_explode",type:createjs.AbstractLoader.BINARY},{id:"teleportin",src:"teleport_gliss_up_effect",type:createjs.AbstractLoader.BINARY},{id:"teleportout",src:"teleport_gliss_down_effect",type:createjs.AbstractLoader.BINARY},{id:"metalhit1",src:"metal_hit1",type:createjs.AbstractLoader.BINARY},{id:"metalhit2",src:"metal_hit2",type:createjs.AbstractLoader.BINARY},{id:"metalhit3",src:"metal_hit3",type:createjs.AbstractLoader.BINARY},{id:"titlewoosh",src:"whoosh",type:createjs.AbstractLoader.BINARY},{id:"satellitesplode",src:"pod_explode",type:createjs.AbstractLoader.BINARY},{id:"asteroidhit1",src:"asteroid_debris_01",type:createjs.AbstractLoader.BINARY},{id:"asteroidhit2",src:"asteroid_debris_02",type:createjs.AbstractLoader.BINARY},{id:"asteroidhit3",src:"asteroid_debris_03",type:createjs.AbstractLoader.BINARY},{id:"asteroidhit4",src:"asteroid_debris_04",type:createjs.AbstractLoader.BINARY},{id:"trunkfordlaugh1",src:"trunkford_laugh_01",type:createjs.AbstractLoader.BINARY},{id:"trunkfordlaugh2",src:"trunkford_laugh_02",type:createjs.AbstractLoader.BINARY},{id:"trunkfordlaugh3",src:"trunkford_laugh_03",type:createjs.AbstractLoader.BINARY},{id:"trunkfordlaugh4",src:"trunkford_laugh_04",type:createjs.AbstractLoader.BINARY},{id:"buttonover",src:"button_rollover",type:createjs.AbstractLoader.BINARY}],g=0;g<f.length;g++)f[g].src="audio/"+f[g].src+d;e=e.concat(f);for(var h=[{id:"skyboxright1",src:"spacesky_right1.jpg"},{id:"skyboxleft2",src:"spacesky_left2.jpg"},{id:"skyboxtop3",src:"spacesky_top3.jpg"},{id:"skyboxbottom4",src:"spacesky_bottom4.jpg"},{id:"skyboxfront5",src:"spacesky_front5.jpg"},{id:"skyboxback6",src:"spacesky_back6.jpg"},{id:"lux",src:"lux.png"},{id:"trunkford",src:"trunkford.png"},{id:"projhitparticle",src:"hit_sprite.png"},{id:"asteroidcolor",src:"asteroid_color.jpg"},{id:"asteroidnormal",src:"asteroid_normal.jpg"},{id:"satellitecolor",src:"mercury_pod_color.jpg"},{id:"starparticle",src:"star.png"},{id:"moonocclusion",src:"moon_lores_occlusion.jpg"},{id:"moonnormal",src:"moon_lores_normal.jpg"},{id:"laserbeam",src:"laser_rippled_128x512.png"},{id:"ufocolor",src:"ufo_col.jpg"},{id:"projcolor",src:"shuttlecock_col.jpg"},{id:"title5",src:"logo_feisty_galaxies.png"},{id:"title1",src:"title_01_luxurious_animals.png"},{id:"title2",src:"title_02_luxamillion.png"},{id:"title3",src:"title_03_dolby.png"},{id:"title4",src:"title_04_trunkford.png"},{id:"titleExtraLux",src:"title_luxamillion_planet.png"},{id:"titleExtraTrunkford",src:"title_trunkford_in_ufo.png"}],g=0;g<h.length;g++)h[g].src="images/"+h[g].src;e=e.concat(h),e.push({id:"ufomodel",src:"models/ufo_test.obj",type:createjs.AbstractLoader.TEXT},{id:"asteroidmodel",src:"models/asteroid01.obj",type:createjs.AbstractLoader.TEXT},{id:"projmodel",src:"models/shuttlecock.obj",type:createjs.AbstractLoader.TEXT},{id:"satellitemodel",src:"models/mercury_pod.obj",type:createjs.AbstractLoader.TEXT},{id:"moonmodel",src:"models/moon_lores.obj",type:createjs.AbstractLoader.TEXT},{id:"satellitedebrismodel",src:"models/pod_chunk.obj",type:createjs.AbstractLoader.TEXT});var i=function(){console.log("Asset load complete."),b&&b()},j=function(b){a&&a(b)},k=function(a){console.log("Error loading asset.",a),c&&c(a)};galaxies.queue=new createjs.LoadQueue(!0),galaxies.queue.on("complete",i),galaxies.queue.on("error",k),galaxies.queue.on("progress",j),galaxies.queue.loadManifest(e)},this.galaxies=this.galaxies||{},galaxies.utils=galaxies.utils||{},galaxies.words={},galaxies.words.verb=["Defend","Save","Protect","Secure","Safeguard","Preserve","Guard"],galaxies.words.adjective=["UnInhabitable","Mysterious","Forbidden","Foreboding","Cosmic","Planetary","Barren","Galactic","Volatile","Wonderous","Interstellar","Celestial","Secretive","Secluded","Extraterrestrial","Rogue","Gaseous","Orbitable","Alien","Lonely","Radioactive"],galaxies.words.size=["Dwarf","Miniature","Diminutive","Compact","Petite","Small","Itty-Bitty","Lil'","Tiny"],galaxies.words.noun=["Planetoid","Moon","Exoplanet","Pulsar","World","Orb","Sphere","Moon Base","Space Outpost","Battlestar","Lunar","Planet"],galaxies.words.greek=["Alpha","Beta","Gamma","Delta","Epsilon","Zeta","Theta","Sigma","Omega","Kappa","Zeta","Centurion","Echo"],galaxies.utils.generatePlanetName=function(a){var b=galaxies.utils.selectRandomElement(galaxies.words.verb)+" the "+galaxies.utils.selectRandomElement(galaxies.words.size)+"<br>"+galaxies.utils.selectRandomElement(galaxies.words.noun)+" "+galaxies.utils.selectRandomElement(galaxies.words.greek)+" "+galaxies.utils.selectRandomElement(galaxies.words.greek)+" "+a;return b=b.toUpperCase()},galaxies.utils.selectRandomElement=function(a){return a[Math.floor(Math.random()*a.length)]},this.galaxies=this.galaxies||{},galaxies.Obstacle=function(a){var b=1.25,c=.35;this.type=a.type,this.particleGroup=a.particleGroup,this.points=a.points,this.explodeType=a.explodeType;var d=0,e=a.tumble,f=e,g=new THREE.Vector3,h=a.tumbleOnHit,i=1.5,j=i,k=a.speed,l=new THREE.Vector3,m=0,n=0,o=60*a.spiral+1;this.ricochetCount=0,this.state="waiting",this.isActive=!1,this.object=a.anchor,this.object.up.set(0,0,1),this.orient=a.orient,this.model=a.model;var p=null,q=[];for(q.push(this.model);q.length>0;){var r=q.shift();if(null!=r){if(null!=r.material){p=r.material;break}for(var s=0,t=r.children.length;t>s;s++)q.push(r.children[s])}}var u=a.hitSound,v=a.explodeSound;this.passSound=null,null!=a.passSound&&(this.passSound=new galaxies.audio.ObjectSound(galaxies.audio.getSound(a.passSound),this.object,0,!0)),"number"!=typeof a.explosionGain&&(a.explosionGain=2);var w=a.explosionGain,x=1.2*galaxies.engine.OBSTACLE_VISIBLE_RADIUS,y=1.2*galaxies.engine.OBSTACLE_VISIBLE_RADIUS;null!=this.passSound&&(y=2*galaxies.engine.OBSTACLE_VISIBLE_RADIUS),this.reset=function(){d=Math.random()*Math.PI*2;var a=new THREE.Vector3(Math.cos(d),Math.sin(d),0);a.multiplyScalar(y),this.object.position.copy(a),this.object.lookAt(new THREE.Vector3),null!==p&&(p.transparent=!1),this.state="waiting",this.isActive=!1,n=3*Math.random(),m=0,l.set(0,0,0),this.speed=k*galaxies.engine.speedScale,g.set(2*Math.random()-1,2*Math.random()-1,2*Math.random()-1),g.normalize(),f=e,j=i},this.update=function(a){switch(this.state){case"retreating":this.object.position.add(l.clone().multiplyScalar(a));break;case"ricocheting":this.object.position.add(l.clone().multiplyScalar(a));var c=galaxies.utils.flatLength(this.object.position);c>x&&this.deactivate(),this.isActive&&c>galaxies.engine.OBSTACLE_VISIBLE_RADIUS&&(this.isActive=!1,null!=p&&(p.transparent=!0));break;case"falling":var e=Math.atan2(-this.object.position.y,-this.object.position.x);d=e-Math.PI/2,m+=a,m=THREE.Math.clamp(m,0,o);var h=THREE.Math.mapLinear(m,0,o,d,e);l.set(Math.cos(h),Math.sin(h),0),l.multiplyScalar(this.speed*a);var c=galaxies.utils.flatLength(this.object.position);if(b>=c&&l.length()<b){this.splode(),galaxies.engine.hitPlayer();break}if(c<galaxies.engine.OBSTACLE_VISIBLE_RADIUS&&(this.isActive=!0),this.object.position.add(l),null!==this.passSound){this.passSound.update(a);var i=2-Math.abs(this.object.position.z-galaxies.engine.CAMERA_Z)/10;i=THREE.Math.clamp(i,0,2),this.passSound.volume=i}break;case"waiting":if(m+=a,m>=n){this.state="falling",galaxies.engine.rootObject.add(this.object),d+=Math.PI/2,n=0,m=0;break}}f?this.object.rotateOnAxis(g,j*a):this.orient&&this.object.lookAt(galaxies.engine.rootObject.position),null!=this.particleGroup&&this.particleGroup.tick(a)},this.removePassSound=function(){null!==this.passSound&&(this.passSound.sound.source.stop(0),this.passSound=null)},this.retreat=function(){this.isActive=!1,this.state="retreating",l.copy(this.object.position),l.z=0,l.setLength(3*c*galaxies.engine.speedScale),h&&(f=!0),this.removePassSound()},this.hit=function(a,b){return null!==this.passSound&&(this.passSound.volume=0),"ricocheting"===this.state?(galaxies.engine.showCombo(this.ricochetCount*this.points,this.object),void this.splode()):(new galaxies.audio.PositionedSound({source:galaxies.audio.getSound(u),position:galaxies.utils.rootPosition(this.object),baseVolume:2,loop:!1}),this.state="ricocheting","undefined"==typeof b?this.ricochetCount=1:this.ricochetCount=b+1,h&&(f=!0,j=i*this.ricochetCount*2.5),l.copy(this.object.position),l.sub(a),l.z=0,void l.setLength(c*galaxies.engine.speedScale))},this.splode=function(){switch(new galaxies.audio.PositionedSound({source:galaxies.audio.getSound(v),position:galaxies.utils.rootPosition(this.object),baseVolume:w,loop:!1}),galaxies.fx.shakeCamera(.5),this.explodeType){case"fireworks":galaxies.fx.showFireworks(this.object.position);break;case"debris":galaxies.fx.showDebris(this.object.position,l);break;case"rubble":default:galaxies.fx.showRubble(this.object.position,l)}this.deactivate()},this.deactivate=function(){null!==this.passSound&&(this.passSound.volume=0),this.state="inactive",this.remove()},this.remove=function(){null!=this.object.parent&&this.object.parent.remove(this.object)},this.destruct=function(){this.removePassSound(),this.remove()},this.reset()},this.galaxies=this.galaxies||{},galaxies.Projectile=function(a,b){this.angularSpeed=10,this.isExpired=!1,this.object=new THREE.Object3D,this.object.up.set(0,0,1);var c=new THREE.Vector3(0,1,0),d=new THREE.Vector3(-Math.sin(b),Math.cos(b),0);d.multiplyScalar(galaxies.engine.PROJ_START_Y),this.object.position.copy(d),d.add(d),this.object.lookAt(d),this.model=a,this.object.add(this.model),this.model.rotation.x=galaxies.engine.CONE_ANGLE,galaxies.utils.conify(this.object),this.lifeTimer=0,this.updatePosition=function(a){var b=galaxies.utils.flatLength(this.object.position);d.set(-Math.sin(a),Math.cos(a),0),d.multiplyScalar(b),this.object.position.copy(d),d.add(d),this.object.lookAt(d),galaxies.utils.conify(this.object)},this.destroy=function(){galaxies.fx.showHit(this.object.position),this.isExpired=!0,this.lifeTimer=this.PROJECTILE_LIFE},this.remove=function(){null!=this.object.parent&&this.object.parent.remove(this.object)},this.addToScene=function(){this.isExpired||galaxies.engine.rootObject.add(this.object)},this.update=function(a){this.object.translateZ(this.PROJECTILE_SPEED*a),this.model.rotateOnAxis(c,this.angularSpeed*a),this.lifeTimer+=a,this.lifeTimer>=this.PROJECTILE_LIFE&&(this.isExpired=!0)}},galaxies.Projectile.prototype.PROJECTILE_SPEED=3,galaxies.Projectile.prototype.PROJECTILE_LIFE=0,this.galaxies=this.galaxies||{},galaxies.SpriteSheet=function(a,b,c){this.framePeriod=1/c,this.frames=b;var d,e=!1,f=0,g=0,h=a.image.width,i=a.image.height;this.texture=a,this.updateFrame=function(a){f=a;var b=this.frames[f];this.texture.repeat.set(b[2]/h,b[3]/i),this.texture.offset.x=b[0]/h,this.texture.offset.y=1-(b[1]+b[3])/i},this.update=function(a){if(e){g+=a;var b=Math.floor(g/this.framePeriod);if(b>f){if(b>=this.frames.length&&(d--,b=0,g=0),0===d)return void this.stop();this.updateFrame(b)}}},this.play=function(a){"undefined"==typeof a&&(a=1),d=a,g=0,f=0,e=!0},this.stop=function(){f=0,this.updateFrame(f),e=!1},this.updateFrame(0)},this.galaxies=this.galaxies||{},galaxies.TitleSequence=function(){var a,b,c=function(){createjs.Tween.removeTweens(p.rotation),createjs.Tween.get(p.rotation).to({x:2*Math.PI/4},l,createjs.Ease.quadIn).to({x:-1*Math.PI/4},0).call(e).to({x:0},l,createjs.Ease.quadOut).call(g),createjs.Tween.removeTweens(o.rotation),createjs.Tween.get(o.rotation).to({z:Math.PI/4},l,createjs.Ease.quadIn).to({z:-Math.PI/4},0).to({z:0},l,createjs.Ease.quadOut);var a=galaxies.engine.rootObject.rotation.x;createjs.Tween.removeTweens(galaxies.engine.rootObject.rotation),createjs.Tween.get(galaxies.engine.rootObject.rotation).to({x:a-Math.PI/4},k,createjs.Ease.quadInOut)},d=function(){createjs.Tween.removeTweens(y.position),createjs.Tween.get(y.position).to({x:0,y:10,z:galaxies.engine.CAMERA_Z+20},0).call(function(){z.sound.startSound()},this).to({x:0,y:10,z:-10},3e3,createjs.Ease.quadInOut)},e=function(){t++,f()},f=function(){F.material=r[t],F.position.set(0,-n,0),F.material.map&&F.scale.set(F.material.map.image.width/w,F.material.map.image.height/w,1),null!=q&&p.remove(q),q=s[t],null!=q&&p.add(q)},g=function(){if(t<r.length-1){var a=j;0===t&&(a/=2),createjs.Tween.removeTweens(this),createjs.Tween.get(this).wait(a).call(c,this),createjs.Tween.get(y,{override:!0}).wait(a-500).call(d,this)}},h=(new THREE.Vector3,new THREE.Vector3(1,0,0)),i=.05,j=4e3,k=500,l=k/2,m=100,n=m-5,o=new THREE.Object3D;o.position.set(0,0,0),b=o;var p=new THREE.Object3D;p.position.set(0,m,0),o.add(p);for(var q,r=[],s=[],t=0,u=["","title5","title1","title2","title3","title4","title5"],v=new THREE.Vector3(1,0,0),w=80,x=0,y=new THREE.Object3D,z=new galaxies.audio.ObjectSound(galaxies.audio.getSound("titlewoosh"),y,5,!1,!1),A=0,B=u.length;B>A;A++)if(""!=u[A]){var C=galaxies.queue.getResult(u[A]),D=new THREE.Texture(C);D.magFilter=THREE.LinearFilter,D.minFilter=THREE.LinearMipMapLinearFilter,D.needsUpdate=!0;var E=new THREE.SpriteMaterial({color:16777215,map:D});r[A]=E}else r[A]=new THREE.SpriteMaterial({map:null,opacity:0,transparent:!0});var F=new THREE.Sprite(r[0]);p.add(F);var G=new THREE.Texture(galaxies.queue.getResult("titleExtraLux"));G.magFilter=THREE.LinearFilter,G.minFilter=THREE.LinearFilter,G.needsUpdate=!0,s[3]=new THREE.Sprite(new THREE.SpriteMaterial({color:16777215,map:G})),s[3].position.set(13,-n,6),s[3].scale.set(s[3].material.map.image.width/70,s[3].material.map.image.height/70,1);var H=new THREE.Texture(galaxies.queue.getResult("titleExtraTrunkford"));H.magFilter=THREE.LinearFilter,H.minFilter=THREE.LinearFilter,H.needsUpdate=!0,s[5]=new THREE.Sprite(new THREE.SpriteMaterial({color:16777215,map:H})),s[5].position.set(16,-n,4),s[5].scale.set(s[5].material.map.image.width/60,s[5].material.map.image.height/60,1),f();var I=function(){galaxies.engine.rootObject.add(b),galaxies.engine.startTimers(),p.rotation.set(0,0,0),p.rotateOnAxis(v,x),t=0,f(),g.call(this),null==a&&K(),h.set(THREE.Math.randFloatSpread(1),THREE.Math.randFloatSpread(1),THREE.Math.randFloatSpread(1)),h.normalize()},J=function(){galaxies.engine.rootObject.remove(b),null!=a&&(window.cancelAnimationFrame(a),a=null),createjs.Tween.removeTweens(this),createjs.Tween.removeTweens(p.rotation),createjs.Tween.removeTweens(o.rotation),createjs.Tween.removeTweens(galaxies.engine.rootObject.rotation),createjs.Tween.removeTweens(y.position)},K=function(){a=requestAnimationFrame(K),L()},L=function(){var a=galaxies.engine.clock.getDelta();0!==a&&(z.update(a),galaxies.engine.driftObject.rotateOnAxis(h,i*a),F.material.rotation=o.rotation.z,galaxies.engine.renderer.render(galaxies.engine.scene,galaxies.engine.camera))};return{activate:I,deactivate:J}},this.galaxies=this.galaxies||{},this.galaxies.Ufo=function(){this.points=2e3,this.object=new THREE.Object3D,this.model=galaxies.engine.geometries.ufo,this.model.children[0].material=galaxies.engine.materials.ufo,this.model.children[1].material=galaxies.engine.materials.ufocanopy,this.model.scale.set(.6,.6,.6),this.model.rotation.set(Math.PI,0,-Math.PI/2),this.object.add(this.model);var a=new THREE.Texture(galaxies.queue.getResult("trunkford"));a.needsUpdate=!0;var b=new THREE.MeshLambertMaterial({map:a,color:16777215,transparent:!0,side:THREE.DoubleSide}),c=new THREE.Mesh(new THREE.PlaneGeometry(1.23,1),b);c.position.set(0,.4,.4),c.scale.set(.6,.6,1),c.rotation.set(0,Math.PI,0),this.model.add(c);var d=new THREE.Object3D;d.add(this.object),this.state="inactive";var e=0,f=0,g=0,h=0,i=2,j=Math.random()*galaxies.utils.PI_2,k=.7,l=(new THREE.Vector3(0,1,0),{type:"sphere",radius:1,speed:-1,sizeStart:1,sizeStartSpread:1,sizeEnd:2,opacityStart:0,opacityEnd:1,colorStart:new THREE.Color(.3,1,.3),colorStartSpread:new THREE.Vector3(.1,.1,.1),colorEnd:new THREE.Color(.5,1,.8),particlesPerSecond:50,particleCount:50,alive:1,duration:.5}),m=new THREE.Texture(galaxies.queue.getResult("starparticle"));m.needsUpdate=!0;var n=new SPE.Group({texture:m,maxAge:1,blending:THREE.AdditiveBlending}),o=new SPE.Emitter(l);n.addEmitter(o),n.mesh.position.x=-.5;var p={type:"cube",acceleration:new THREE.Vector3(0,0,-3),velocity:new THREE.Vector3(0,-2,0),velocitySpread:new THREE.Vector3(1,1,1),sizeStart:3,sizeStartSpread:1,sizeEnd:3,opacityStart:1,opacityEnd:0,colorStart:new THREE.Color(.6,.6,.6),colorStartSpread:new THREE.Vector3(.1,.1,.1),colorEnd:new THREE.Color(.2,.2,.2),particlesPerSecond:10,particleCount:50,alive:0,duration:null},q=new THREE.Texture(galaxies.queue.getResult("projhitparticle"));q.needsUpdate=!0;var r=new SPE.Group({texture:q,maxAge:2,blending:THREE.NormalBlending}),s=new SPE.Emitter(p);r.addEmitter(s),this.object.add(r.mesh),this.object.add(n.mesh);var t=new THREE.Object3D;t.position.set(-.5,0,0),t.rotation.set(0,2.03,0);var u=new THREE.PlaneGeometry(5,.3),v=new THREE.Texture(galaxies.queue.getResult("laserbeam"));v.needsUpdate=!0;var w=new THREE.MeshBasicMaterial({map:v,side:THREE.DoubleSide,transparent:!0,opacity:1}),x=new THREE.Mesh(u,w);x.position.set(2.5,0,0),t.add(x),this.ufoSound=new galaxies.audio.ObjectSound(galaxies.audio.getSound("ufo"),this.object,0);var y=galaxies.engine.CAMERA_Z+10,z=new THREE.Vector3(1,0,y),A=[new THREE.Vector3(galaxies.engine.VISIBLE_RADIUS,0,0),new THREE.Vector3(.9*galaxies.engine.VISIBLE_RADIUS,0,0),new THREE.Vector3(.75*galaxies.engine.VISIBLE_RADIUS,0,0)];A[0].z=galaxies.utils.getConifiedDepth(A[0]),A[1].z=galaxies.utils.getConifiedDepth(A[1]),A[2].z=galaxies.utils.getConifiedDepth(A[2]);
var B,C=A[1],D=createjs.Ease.quadInOut,E=0;this.object.position.copy(z);var F=z,G=z,H=0,I=0;this.isHittable=!1,this.alive=!0,this.update=function(a){switch(e+=a,this.state){case"idle":if(e>=f){this.state="in",f=4,g=4,e=0,F=this.object.position.clone(),G=C,j=Math.round(Math.random())*Math.PI-Math.PI/4;var b=k/(2*g),c=j;B=function(a){return b*a*a+c},this.isHittable=!0,this.model.rotation.y=Math.PI/3,createjs.Tween.removeTweens(this.model.rotation),createjs.Tween.get(this.model.rotation).wait(2e3).to({y:0},2e3,createjs.Ease.quadOut),new galaxies.audio.PositionedSound({source:galaxies.audio.getSound("trunkfordlaugh"),position:new THREE.Vector3(0,0,1.5*galaxies.engine.CAMERA_Z),baseVolume:4,loop:!1})}break;case"in":j=B(e),e>=f&&(this.state="orbit",f=1,g=f/4,e=0,E=0,F=this.object.position.clone(),G=C);break;case"orbit":j+=k*a,e>=f&&(o.alive=1,createjs.Tween.get(x).wait(1e3).call(function(){new galaxies.audio.PositionedSound({source:galaxies.audio.getSound("ufoshoot"),position:galaxies.utils.rootPosition(this.object),baseVolume:1.5,loop:!1}),this.object.add(t),x.material.opacity=1,createjs.Tween.get(x.material).to({opacity:0},300,createjs.Ease.quadOut).call(function(){this.object.remove(t)},null,this),t.rotation.z=(2*Math.round(Math.random())-1)*Math.PI/16,E>2&&(galaxies.engine.hitPlayer(),this.leave(),t.rotation.z=0)},null,this),E++,e=0,f=2);break;case"out":j=THREE.Math.mapLinear(e,0,g/2,H,I),e>=f&&this.reset()}var h=THREE.Math.clamp(e/g,0,1);h=D(THREE.Math.clamp(h,0,1)),this.object.position.lerpVectors(F,G,h),d.rotation.set(0,0,j),this.ufoSound.update(a);var i=y-this.object.position.z;i=THREE.Math.clamp(i,0,1),this.ufoSound.volume=i,n.tick(a),r.tick(a)},this.leave=function(){this.state="out",e=0,f=4,g=4,this.isHittable=!1,F=this.object.position.clone(),G=z,createjs.Tween.removeTweens(x);var a=(j+Math.PI)%galaxies.utils.PI_2-Math.PI;j=a,H=j,I=(Math.floor(j/Math.PI)+1)*Math.PI,createjs.Tween.removeTweens(this.model.rotation),createjs.Tween.get(this.model.rotation).to({y:Math.PI/3},2e3,createjs.Ease.quadIn)},this.hit=function(){h++,h>=i&&(this.leave(),galaxies.engine.showCombo(this.points,this.object)),s.alive=1,new galaxies.audio.PositionedSound({source:galaxies.audio.getSound("ufohit"),position:galaxies.utils.rootPosition(this.object),baseVolume:1,loop:!1})},this.reset=function(){return this.state="idle",e=0,h=0,s.alive=0,galaxies.engine.isGameOver?void this.deactivate():(f=5*Math.random()+5,this.isHittable=!1,F=z,G=z,this.object.position.copy(z),void(this.ufoSound.volume=0))},this.activate=function(){this.reset(),galaxies.engine.rootObject.add(d)},this.deactivate=function(){this.state="inactive",this.isHittable=!1,F=z,G=z,this.object.position.copy(z),this.ufoSound.volume=0,galaxies.engine.rootObject.remove(d)},this.deactivate()},this.galaxies=this.galaxies||{},galaxies.ui=function(){function a(a){galaxies.audio.playSound(galaxies.audio.getSound("buttonover"))}var b,c=document.getElementById("menuHolder"),d=c.querySelector(".loading"),e=c.querySelector(".progress-title"),f=c.querySelector(".play-symbol"),g=c.querySelector(".progress"),h=c.querySelector(".progress-ring"),i=c.querySelector(".play-place"),j=c.querySelector(".play-button"),k=d.querySelector(".recommend-safari"),l=d.querySelector(".recommend-edge"),m=d.querySelector(".audio-controls"),n=m.querySelector(".stereo-button"),o=m.querySelector(".surround-button"),p=c.querySelector(".mute-button"),q=c.querySelector(".dolby-logo"),r=c.querySelector(".game-ui"),s=c.querySelector(".pause-button"),t=r.querySelector(".level-display-text"),u=r.querySelector(".life-display"),v=u.querySelectorAll(".life-heart"),w=r.querySelector(".score-display-text"),x=c.querySelector(".pause-overlay"),y=c.querySelector(".pause-menu"),z=y.querySelector(".pause-title"),A=y.querySelector(".resume-button"),B=y.querySelector(".restart-button"),C=y.querySelector(".quit-button"),D=c.querySelector(".game-over-menu"),E=D.querySelector(".game-over-title"),F=D.querySelector(".restart-button"),G=D.querySelector(".quit-button"),H=c.querySelector(".title"),I=document.getElementById("container"),J=function(){var a=i.querySelector(".progress-fill-a"),b=i.querySelector(".progress-fill-b"),c=!1,d=function(d){var e=360*d-180;if(c){var f=b.style;f["-webkit-transform"]="rotate("+e+"deg)",f.transform="rotate("+e+"deg)"}else{var f=a.style;f["-webkit-transform"]="rotate("+e.toFixed(2)+"deg)",f.transform="rotate("+e.toFixed(2)+"deg)",d>=.5&&(c=!0,f["-webkit-transform"]="rotate(0deg)",f.transform="rotate(0deg)",b.classList.remove("hidden"))}};return{update:d}}(),K=function(){function b(){e.classList.add("logo-loading-layout")}createjs.CSSPlugin.install(),j.addEventListener("click",Z),j.addEventListener("mouseover",a),j.addEventListener("touchstart",Z),j.addEventListener("touchstart",Y),p.addEventListener("click",$),p.addEventListener("mousedown",Y),p.addEventListener("mouseover",a),p.addEventListener("touchstart",$),p.addEventListener("touchstart",Y),s.addEventListener("click",_),s.addEventListener("mousedown",Y),s.addEventListener("mouseover",a),s.addEventListener("touchstart",_),s.addEventListener("touchstart",Y),A.addEventListener("click",aa),A.addEventListener("mouseover",a),A.addEventListener("touchstart",Y),A.addEventListener("touchstart",aa),B.addEventListener("click",ba),B.addEventListener("mouseover",a),B.addEventListener("touchstart",Y),B.addEventListener("touchstart",ba),F.addEventListener("click",ba),F.addEventListener("mouseover",a),F.addEventListener("touchstart",Y),F.addEventListener("touchstart",ba),C.addEventListener("click",ca),C.addEventListener("mouseover",a),C.addEventListener("touchstart",Y),C.addEventListener("touchstart",ca),G.addEventListener("click",ca),G.addEventListener("mouseover",a),G.addEventListener("touchstart",Y),G.addEventListener("touchstart",ca),n.addEventListener("click",ea),n.addEventListener("mouseover",a),o.addEventListener("click",fa),o.addEventListener("mouseover",a),k.addEventListener("mouseover",a),l.addEventListener("mouseover",a),b(),galaxies.utils.testAudioSupport(L)},L=function(){var a=function(){galaxies.audio.initAudio(M)},b=function(a){g.innerHTML=Math.round(100*a.progress).toString(),J.update(a.progress)};galaxies.loadAssets(b,a)},M=function(){console.log("Transition loading layout to main menu."),galaxies.audio.soundField=new galaxies.audio.SoundField(galaxies.audio.getSound("music")),galaxies.audio.soundField.setVolume(.24),e.classList.add("fade-out"),galaxies.engine.initScene(),b=new galaxies.TitleSequence,b.activate(),createjs.Tween.get(g).wait(1e3).call(N,this)},N=function(){g.style.left=0,createjs.Tween.get(g).to({left:52},500,createjs.Ease.quadInOut).call(O);var a=window.getComputedStyle(f,null).getPropertyValue("left");f.style.left=a,createjs.Tween.get(f).to({left:0},500,createjs.Ease.quadInOut),galaxies.utils.supportsEC3||(galaxies.utils.isOSX()?(k.classList.remove("hidden"),window.getComputedStyle(k).bottom,k.classList.add("browser-recommend-on")):galaxies.utils.isWindows()&&(l.classList.remove("hidden"),window.getComputedStyle(l).bottom,l.classList.add("browser-recommend-on"))),galaxies.utils.isMobile()||(m.classList.add("fade-in"),m.classList.remove("hidden")),p.classList.remove("hidden"),p.classList.add("fade-in"),galaxies.utils.supportsEC3&&(q.classList.add("fade-in"),q.classList.remove("hidden"))},O=function(){h.classList.add("hidden"),j.classList.remove("hidden")},P=function(){r.classList.add("hidden"),da(),ia(),X(),e.classList.remove("fade-out"),e.classList.add("hidden"),b.activate(),d.classList.remove("hidden")},Q=function(){s.classList.remove("hidden"),window.getComputedStyle(s).left,s.classList.add("pause-button-on")},R=function(){s.classList.remove("pause-button-on"),s.classList.add("hidden")},S=[],T=!1,U=null,V=function(a,b){var c={text:a,time:1e3*b};S.push(c),T&&0!==U.time||W()},W=function(){if(0==S.length)return void X();T=!0;var a=S.shift();H.innerHTML=a.text,H.classList.remove("hidden"),window.getComputedStyle(H).top,H.classList.add("title-on"),createjs.Tween.removeTweens(H),a.time>0&&createjs.Tween.get(H).wait(a.time).call(function(){H.classList.remove("title-on")},this).wait(1e3).call(W),U=a},X=function(){H.classList.remove("title-on"),H.classList.add("hidden"),S=[],U=null,createjs.Tween.removeTweens(H),T=!1},Y=function(a){a.stopPropagation()},Z=function(a){d.classList.add("hidden"),b.deactivate(),r.classList.remove("hidden"),Q(),galaxies.engine.gameInitialized?galaxies.engine.restartGame():galaxies.engine.initGame()},$=function(a){a.preventDefault(),galaxies.audio.toggleMuteState(),"music"===galaxies.audio.muteState||"all"===galaxies.audio.muteState,console.log("Toggle mute")},_=function(a){a.preventDefault(),x.classList.remove("hidden"),window.getComputedStyle(x).top,x.classList.add("pause-overlay-on"),y.classList.remove("hidden"),window.getComputedStyle(z).top,z.classList.add("pause-title-on"),galaxies.engine.pauseGame()},aa=function(a){da(),galaxies.engine.resumeGame()},ba=function(a){da(),ia(),galaxies.engine.restartGame()},ca=function(a){da(),galaxies.engine.endGame()},da=function(){z.classList.remove("pause-title-on"),window.getComputedStyle(z).top,y.classList.add("hidden"),x.classList.add("hidden"),x.classList.remove("pause-overlay-on")},ea=function(a){galaxies.audio.toggleTargetMix(!1)},fa=function(a){galaxies.audio.toggleTargetMix(!0)},ga=function(a){a?(n.classList.remove("active"),o.classList.add("active")):(n.classList.add("active"),o.classList.remove("active"))},ha=function(){D.classList.remove("hidden"),window.getComputedStyle(E).top,E.classList.add("game-over-title-on"),V("SCORE "+w.innerHTML+"<br>"+t.innerHTML,0)},ia=function(){E.classList.remove("game-over-title-on"),window.getComputedStyle(E).top,D.classList.add("hidden")},ja=function(a,b){t.innerHTML="WORLD "+a.toString()+"-"+b.toString()},ka=function(a){w.innerHTML=a.toString()},la=function(a){for(var b=0;b<v.length;b++)a>=b+1?v[b].classList.remove("empty"):v[b].classList.add("empty")};return{init:K,gameContainer:I,showMenu:P,showGameOver:ha,showPauseButton:Q,hidePauseButton:R,showTitle:V,clearTitle:X,updateLevel:ja,updateScore:ka,updateLife:la,setMixButtons:ga}}(),this.galaxies=this.galaxies||{},galaxies.utils=this.galaxies.utils||{},galaxies.utils.PI_2=2*Math.PI,galaxies.utils.getShakeEase=function(a){return function(b){var c=Math.cos(b*a)*(1-b);return c}},galaxies.utils.isOSX=function(){var a=navigator.userAgent;return/Mac OS X/.test(a)&&!/iphone/i.test(a)&&!/ipad/i.test(a)&&!/ipod/i.test(a)},galaxies.utils.isWindows=function(){var a=navigator.userAgent;return/Windows/.test(a)&&!/phone/i.test(a)},galaxies.utils.isMobile=function(){var a=navigator.userAgent;return/iPhone|iPad|iPod|Android|windows phone|iemobile|\bsilk\b/i.test(a)},galaxies.utils.testAudioSupport=function(a){if("undefined"!=typeof galaxies.utils.supportsOGG)return void a();var b=document.createElement("audio"),c='audio/ogg;codecs="vorbis"';galaxies.utils.supportsOGG="probably"===b.canPlayType(c),console.log("Supports OGG?",galaxies.utils.supportsOGG);var d=document.createElement("video");if(""===d.canPlayType('audio/mp4;codecs="ec-3"')||""===d.canPlayType('audio/mp4;codecs="ac-3"'))galaxies.utils.supportsEC3=!1,a();else{var e=new Audio;e.muted=!0,e.addEventListener("error",function(){galaxies.utils.supportsEC3=!1,a()},!1),e.addEventListener("seeked",function(){galaxies.utils.supportsEC3=!0,a()},!1),e.addEventListener("canplaythrough",function(){try{e.currentTime=2}catch(b){a()}},!1),e.src="audio/silence.mp4",e.play()}},galaxies.utils.isSupportedBrowser=function(){var a,b;try{a=document.createElement("canvas"),b=a.getContext("webgl")||a.getContext("experimental-webgl")}catch(c){return!1}if(void 0===b)return!1;a=void 0;var d=window.AudioContext||window.webkitAudioContext;return null==d?!1:!0},galaxies.ExhaustiveArray=function(){var a=[],b=0,c=function(){for(var b=0;b<a.length;b++){var c=Math.floor(Math.random()*(b+1)),d=a[c];a[c]=a[b],a[b]=d}};this.add=function(b){a.push(b)},this.init=function(){b=0,c()},this.next=function(){var d=a[b];return a.length>1&&(b++,b>=a.length&&(b=0,c())),d},c()},galaxies.utils.flatLength=function(a){return Math.sqrt(Math.pow(a.x,2)+Math.pow(a.y,2))},galaxies.utils.flatLengthSqr=function(a){return Math.pow(a.x,2)+Math.pow(a.y,2)},galaxies.utils.rootPosition=function(a){var b=a.position.clone();return null==a.parent||null==galaxies.engine.rootObject?b:galaxies.engine.rootObject.worldToLocal(a.parent.localToWorld(b))},galaxies.utils.conify=function(a){a.position.setZ(galaxies.utils.getConifiedDepth(a.position))},galaxies.utils.getConifiedDepth=function(a){return galaxies.utils.flatLength(a)/galaxies.engine.CONE_SLOPE},SPE.Emitter.prototype.randomizeExistingVelocityVector3OnSphere=function(a,b,c,d,e){a.copy(c).sub(b).normalize().multiplyScalar(this.randomFloat(d,e))};